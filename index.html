<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales Portal</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link 
    rel="stylesheet" 
    href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script 
    src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js">
  </script>
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
  </script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { margin-right: 1rem; }
    select { margin-right: 2rem; }
    table.dataTable { margin-top: 1rem; width: 100%; }
  </style>
</head>
<body>
  <h1>Sales Portal</h1>

  <label>Salesman:
    <select id="salesFilter"><option value="">All</option></select>
  </label>
  <label>Day:
    <select id="dayFilter"><option value="">All</option></select>
  </label>
  <label>Week:
    <select id="weekFilter">
      <option value="">All</option>
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
      <option value="4">Week 4</option>
    </select>
  </label>

  <table id="outletTable" class="display">
    <thead>
      <tr>
        <th>Kode</th><th>Outlet</th><th>Target</th>
        <th>Greentea</th><th>OT Check May</th><th>Sales</th>
        <th>Hari</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  (function(){
    // ←––––––––––– CHANGE THIS to your sheet’s CSV URL –––––––––––→
    const CSV_URL = 
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdbD6lgSNm6VyLRS4nJPMstGaZB-pgISgyyC2tSHLKIq5AwIDZLjV6wr45zrlvBatiTPycaJmpL0wy/pub?output=csv';

    // Utility to populate a <select> from distinct values of colName
    function populateSelect(selId, rows, colName) {
      const seen = [...new Set(rows.map(r => r[colName]).filter(v=>v))].sort();
      const sel = document.getElementById(selId);
      seen.forEach(v => {
        const opt = new Option(v, v);
        sel.add(opt);
      });
    }

    // 1) Fetch & parse CSV
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      error: err => console.error('CSV Error', err),
      complete: res => {
        // 2) Trim all header keys
        const data = res.data.map(rawRow => {
          const row = {};
          Object.keys(rawRow).forEach(k => {
            row[k.trim()] = rawRow[k];
          });
          return row;
        });
        if (!data.length) {
          document.body.insertAdjacentHTML('beforeend',
            '<p style="color:red">No data found – check your CSV_URL and Sheet</p>');
          return;
        }

        // 3) Populate Salesman & Day filters
        populateSelect('salesFilter', data, 'SALES');
        populateSelect('dayFilter',   data, 'HARI');

        // 4) Initialize DataTable
        const table = $('#outletTable').DataTable({
          data: data,
          columns: [
            { data: 'KODE',           title: 'Kode'          },
            { data: 'OUTLET',         title: 'Outlet'        },
            { data: 'Target',         title: 'Target'        },
            { data: 'GREENTEA',       title: 'Greentea'      },
            { data: 'OT Check MAY',   title: 'OT Check May'  },
            { data: 'SALES',          title: 'Sales'         },
            { data: 'HARI',           title: 'Hari'          },
            { data: 'W1',             title: 'W1'            },
            { data: 'W2',             title: 'W2'            },
            { data: 'W3',             title: 'W3'            },
            { data: 'W4',             title: 'W4'            }
          ],
          pageLength: 25
        });

        // 5) On filter‐change, re‐filter the raw data and redraw
        $('#salesFilter, #dayFilter, #weekFilter').on('change', () => {
          const s = $('#salesFilter').val();
          const d = $('#dayFilter').val();
          const w = $('#weekFilter').val();

          const filtered = data.filter(r => {
            if (s && r.SALES !== s) return false;
            if (d && r.HARI  !== d) return false;
            if (w) {
              // check W1–W4 as numbers >0
              const flag = parseFloat(r['W'+w]) || 0;
              if (flag <= 0) return false;
            }
            return true;
          });

          table.clear();
          table.rows.add(filtered);
          table.draw();
        });
      }
    });
  })();
  </script>
</body>
</html>
