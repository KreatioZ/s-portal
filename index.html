<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales Portal</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables CSS & JS -->
  <link 
    rel="stylesheet" 
    href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script 
    src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js">
  </script>
  <!-- PapaParse for CSV parsing -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
  </script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { margin-right: 1rem; }
    select { margin-right: 2rem; }
    table.dataTable { margin-top: 1rem; width: 100%; }
  </style>
</head>
<body>
  <h1>Sales Portal</h1>

  <!-- Filters -->
  <label>Salesman:
    <select id="salesFilter"><option value="">All</option></select>
  </label>
  <label>Day:
    <select id="dayFilter"><option value="">All</option></select>
  </label>
  <label>Week:
    <select id="weekFilter">
      <option value="">All</option>
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
      <option value="4">Week 4</option>
    </select>
  </label>

  <!-- Table placeholder -->
  <table id="outletTable" class="display">
    <thead>
      <tr>
        <th>Kode</th>
        <th>Outlet</th>
        <th>Target</th>
        <th>Greentea</th>
        <th>OT Check May</th>
        <th>Sales</th>
        <th>Hari</th>
        <th>W1</th>
        <th>W2</th>
        <th>W3</th>
        <th>W4</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  (function(){
    // 1) Paste your published‐CSV URL here (with &output=csv)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdbD6lgSNm6VyLRS4nJPMstGaZB-pgISgyyC2tSHLKIq5AwIDZLjV6wr45zrlvBatiTPycaJmpL0wy/pub?output=csv';

    // 2) Helper to fill dropdowns from the data
    function populateFilter(id, data, col) {
      const seen = new Set();
      data.forEach(r => r[col] && seen.add(r[col]));
      const sel = document.getElementById(id);
      Array.from(seen).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    // 3) Custom filter logic for Week
    $.fn.dataTable.ext.search.push(function(settings, row){
      const salesVal = $('#salesFilter').val();
      const dayVal   = $('#dayFilter').val();
      const weekVal  = $('#weekFilter').val();
      // row is an array: [ Kode, Outlet, Target, Greentea, OT, Sales, Hari, W1, W2, W3, W4 ]
      const [ , , , , , , hari, w1, w2, w3, w4 ] = row;

      // Salesman filter (column 5 in the original object)
      if(salesVal && row[5] !== salesVal) return false;
      // Day filter
      if(dayVal   && hari  !== dayVal ) return false;
      // Week filter
      if(weekVal) {
        const flag = row[6 + parseInt(weekVal,10)]; // W1→index7, W2→8, etc
        if(!(flag && parseInt(flag,10) > 0)) return false;
      }
      return true;
    });

    // 4) Fetch & parse
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      error: err => console.error('CSV error:', err),
      complete: results => {
        const data = results.data;
        console.log('CSV rows:', data.length);

        if(!data.length) {
          document.body.insertAdjacentHTML('beforeend',
            '<p style="color:red">⚠️ No data—check your CSV_URL or Sheet permissions.</p>');
          return;
        }

        // 5) Populate Salesman & Day filters
        populateFilter('salesFilter', data, 'SALES');
        populateFilter('dayFilter',   data, 'HARI');

        // 6) Initialize DataTable by mapping directly to your sheet’s objects
        const table = $('#outletTable').DataTable({
          data: data,
          columns: [
            { title: 'Kode',         data: 'KODE'          },
            { title: 'Outlet',       data: 'OUTLET'        },
            { title: 'Target',       data: 'Target'        },
            { title: 'Greentea',     data: 'GREENTEA'      },
            { title: 'OT Check May', data: 'OT Check MAY'  },
            { title: 'Sales',        data: 'SALES'         },
            { title: 'Hari',         data: 'HARI'          },
            { title: 'W1',           data: 'W1'            },
            { title: 'W2',           data: 'W2'            },
            { title: 'W3',           data: 'W3'            },
            { title: 'W4',           data: 'W4'            }
          ],
          pageLength: 25
        });

        // 7) Redraw on any filter change
        $('#salesFilter, #dayFilter, #weekFilter')
          .on('change', () => table.draw());
      }
    });

  })();
  </script>
</body>
</html>
