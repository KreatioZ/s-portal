<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales Portal</title>
  <!-- DataTables & jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link 
    rel="stylesheet" 
    href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script 
    src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js">
  </script>
  <!-- PapaParse for CSV -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
  </script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { margin-right: 1rem; }
    select { margin-right: 2rem; }
    table.dataTable { margin-top: 1rem; width: 100%; }
  </style>
</head>
<body>
  <h1>Sales Portal</h1>

  <!-- Filters -->
  <label>Salesman:
    <select id="salesFilter"><option value="">All</option></select>
  </label>
  <label>Day:
    <select id="dayFilter"><option value="">All</option></select>
  </label>
  <label>Week:
    <select id="weekFilter">
      <option value="">All</option>
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
      <option value="4">Week 4</option>
    </select>
  </label>

  <!-- Data table placeholder -->
  <table id="outletTable" class="display">
    <thead><tr>
      <th>Kode</th><th>Outlet</th><th>Target</th>
      <th>Greentea</th><th>OT Check May</th><th>Sales</th>
      <th>Hari</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th>
    </tr></thead>
    <tbody></tbody>
  </table>

  <script>
  (function(){
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdbD6lgSNm6VyLRS4nJPMstGaZB-pgISgyyC2tSHLKIq5AwIDZLjV6wr45zrlvBatiTPycaJmpL0wy/pub?output=csv';
    
    // Helpers to populate a select from distinct column values
    function populateFilter(id, data, col) {
      const seen = new Set();
      data.forEach(r => r[col] && seen.add(r[col]));
      const sel = document.getElementById(id);
      Array.from(seen).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    // Custom DataTables filter for week
    $.fn.dataTable.ext.search.push(function(settings, row){
      const [ , , , , , , hari, w1,w2,w3,w4 ] = row;
      const sales = $('#salesFilter').val();
      const day   = $('#dayFilter').val();
      const week  = $('#weekFilter').val();
      // Salesman filter (row[5])
      if(sales && row[5] !== sales) return false;
      // Day filter
      if(day && hari !== day) return false;
      // Week filter
      if(week) {
        const flag = row[7 + (parseInt(week,10)-1)];
        if(!(flag && parseInt(flag,10) > 0)) return false;
      }
      return true;
    });

    // Load CSV, initialize table & filters
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        // populate Salesman & Day filters
        populateFilter('salesFilter', data, 'SALES');
        populateFilter('dayFilter',   data, 'HARI');

        // Build DataTable
        $('#outletTable').DataTable({
          data: data.map(r => [
            r['KODE'], r['OUTLET'], r['Target'],
            r['GREENTEA'], r['OT Check MAY'], r['SALES'],
            r['HARI'],    r['W1'],         r['W2'],
            r['W3'],      r['W4']
          ]),
          columns: [
            { title: 'Kode' }, { title: 'Outlet' }, { title: 'Target' },
            { title: 'Greentea' }, { title: 'OT Check May' }, { title: 'Sales' },
            { title: 'Hari' }, { title: 'W1' }, { title: 'W2' },
            { title: 'W3' }, { title: 'W4' }
          ],
          pageLength: 25
        });

        // Redraw on filter change
        $('#salesFilter, #dayFilter, #weekFilter').on('change', function(){
          $('#outletTable').DataTable().draw();
        });
      }
    });
  })();
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  error: err => console.error('CSV fetch/parse error:', err),
  complete: results => {
    console.log('ðŸŽ‰ CSV loaded, rows:', results.data.length, results.data);
    
    if (!results.data.length) {
      document.body.insertAdjacentHTML('beforeend',
        '<p style="color:red">No rows found â€“ check your sheet or CSV_URL</p>');
      return;
    }

    // â€¦ rest of your initialization
  }
});    
  </script>
</body>
</html>
