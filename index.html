<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales Portal</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables CSS & JS -->
  <link 
    rel="stylesheet" 
    href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script 
    src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js">
  </script>
  <!-- PapaParse for CSV -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
  </script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { margin-right: 1rem; }
    select { margin-right: 2rem; }
    table.dataTable { margin-top: 1rem; width: 100%; }
  </style>
</head>
<body>
  <h1>Sales Portal</h1>

  <!-- Filters -->
  <label>Salesman:
    <select id="salesFilter"><option value="">All</option></select>
  </label>
  <label>Day:
    <select id="dayFilter"><option value="">All</option></select>
  </label>
  <label>Week:
    <select id="weekFilter">
      <option value="">All</option>
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
      <option value="4">Week 4</option>
    </select>
  </label>

  <!-- Table container -->
  <table id="outletTable" class="display">
    <thead><tr>
      <th>Kode</th>
      <th>Outlet</th>
      <th>Target</th>
      <th>Greentea</th>
      <th>OT Check May</th>
      <th>Sales</th>
      <th>Hari</th>
      <th>W1</th>
      <th>W2</th>
      <th>W3</th>
      <th>W4</th>
    </tr></thead>
    <tbody></tbody>
  </table>

  <script>
  (function(){
    // ←– Replace with your actual published‐CSV URL (must end in &output=csv) –→
    const CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdbD6lgSNm6VyLRS4nJPMstGaZB-pgISgyyC2tSHLKIq5AwIDZLjV6wr45zrlvBatiTPycaJmpL0wy/pub?output=csv';

    let rawData = [], table = null;

    // Populate a <select> with the distinct values of 'key'
    function fill(selectId, rows, key) {
      const vals = [...new Set(rows.map(r => r[key]).filter(v=>v))].sort();
      const sel  = document.getElementById(selectId);
      vals.forEach(v => sel.add(new Option(v, v)));
    }

    // Build the <tbody> HTML, then DataTables()
    function render(rows, targetMap) {
      if (table) table.destroy();
      const $body = $('#outletTable tbody').empty();

      rows.forEach(r => {
        const t = targetMap[r.kode] || '';
        const $tr = $('<tr>');
        [ r.kode, r.outlet, t, r.greentea, r['ot check may'],
          r.sales, r.hari, r.w1, r.w2, r.w3, r.w4 ]
        .forEach(val => $tr.append($('<td>').text(val)));
        $body.append($tr);
      });

      table = $('#outletTable').DataTable({
        pageLength: 25,
        columnDefs: [{ targets: 2, type: 'num' }] // numeric sort on Target
      });
    }

    // Apply filters & re-render
    function applyFilters(targetMap) {
      const s = $('#salesFilter').val(),
            d = $('#dayFilter').val(),
            w = $('#weekFilter').val();

      const filtered = rawData.filter(r => {
        if (s && r.sales     !== s) return false;
        if (d && r.hari      !== d) return false;
        if (w) {
          const v = +(r['w'+w]) || 0;
          if (v <= 0) return false;
        }
        return true;
      });
      render(filtered, targetMap);
    }

    // Fetch & parse
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      error: err => {
        console.error('CSV error', err);
        alert('Failed to load your sheet. Check the CSV_URL & sharing settings.');
      },
      complete: res => {
        // Normalize all headers to lower-case trimmed keys,
        // and trim all values to strings:
        rawData = res.data.map(r => {
          const o = {};
          Object.keys(r).forEach(origKey => {
            const key = origKey.trim().toLowerCase();
            o[key]  = (r[origKey]||'').toString().trim();
          });
          return o;
        });

        // Build a KODE→Target map (first non-empty target wins)
        const targetMap = {};
        rawData.forEach(r => {
          if (r.kode && r.target && !targetMap[r.kode]) {
            targetMap[r.kode] = r.target;
          }
        });

        // Populate filters
        fill('salesFilter', rawData, 'sales');
        fill('dayFilter',   rawData, 'hari');

        // Initial render (all rows)
        render(rawData, targetMap);

        // Re-render when any filter changes
        $('#salesFilter,#dayFilter,#weekFilter')
          .on('change', () => applyFilters(targetMap));
      }
    });
  })();
  </script>
</body>
</html>
